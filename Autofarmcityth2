--// Auto Farm New Spot System
--// Separate GUI, doesn't overlap with v3.1

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

--// Configuration
local Config = {
    FirstPosition = Vector3.new(356.83, 167.65, 79.05),
    SecondPosition = Vector3.new(445.91, 167.82, 70.02),
    HoldTime = 1.0,
    InteractRange = 15
}

--// State
local State = {
    isFarming = false,
    isMinimized = false,
    connections = {}
}

--// GUI - Positioned differently from v3.1
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoFarmNewSpot"
ScreenGui.Parent = CoreGui
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260, 0, 180)
MainFrame.Position = UDim2.new(0.02, 0, 0.55, 0) -- Below v3.1 GUI
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 25, 40)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Parent = ScreenGui

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 12)
Corner.Parent = MainFrame

local Stroke = Instance.new("UIStroke")
Stroke.Color = Color3.fromRGB(150, 50, 255)
Stroke.Thickness = 2
Stroke.Parent = MainFrame

-- Title
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 38)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 40, 60)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleText = Instance.new("TextLabel")
TitleText.Size = UDim2.new(0.6, 0, 1, 0)
TitleText.Position = UDim2.new(0, 12, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "üéØ AUTO SPOT"
TitleText.TextColor3 = Color3.fromRGB(180, 100, 255)
TitleText.TextSize = 16
TitleText.Font = Enum.Font.GothamBold
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Parent = TitleBar

-- Buttons
local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Size = UDim2.new(0, 32, 0, 28)
MinimizeBtn.Position = UDim2.new(1, -75, 0, 5)
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
MinimizeBtn.Text = "‚àí"
MinimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeBtn.TextSize = 18
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.Parent = TitleBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 32, 0, 28)
CloseBtn.Position = UDim2.new(1, -38, 0, 5)
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 100)
CloseBtn.Text = "√ó"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 18
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Parent = TitleBar

-- Content
local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, 0, 1, -38)
ContentFrame.Position = UDim2.new(0, 0, 0, 38)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -20, 0, 26)
StatusLabel.Position = UDim2.new(0, 10, 0, 10)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "‚èπÔ∏è STOPPED"
StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
StatusLabel.TextSize = 15
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.Parent = ContentFrame

local InfoLabel = Instance.new("TextLabel")
InfoLabel.Size = UDim2.new(1, -20, 0, 18)
InfoLabel.Position = UDim2.new(0, 10, 0, 36)
InfoLabel.BackgroundTransparency = 1
InfoLabel.Text = "Hold: 1.0s | 2 Points"
InfoLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
InfoLabel.TextSize = 11
InfoLabel.Font = Enum.Font.Gotham
InfoLabel.Parent = ContentFrame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0.88, 0, 0, 40)
ToggleBtn.Position = UDim2.new(0.06, 0, 0, 60)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 255)
ToggleBtn.Text = "‚ñ∂ START"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 16
ToggleBtn.Font = Enum.Font.GothamBlack
ToggleBtn.Parent = ContentFrame

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 8)
ToggleCorner.Parent = ToggleBtn

local ProgressLabel = Instance.new("TextLabel")
ProgressLabel.Size = UDim2.new(1, -20, 0, 22)
ProgressLabel.Position = UDim2.new(0, 10, 0, 108)
ProgressLabel.BackgroundTransparency = 1
ProgressLabel.Text = "Ready"
ProgressLabel.TextColor3 = Color3.fromRGB(180, 150, 255)
ProgressLabel.TextSize = 13
ProgressLabel.Font = Enum.Font.GothamBold
ProgressLabel.Parent = ContentFrame

--// Drag System
local dragging = false
local dragStart = nil
local startPos = nil

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

--// Core Functions
local function UpdateCharacter()
    Character = LocalPlayer.Character
    if Character then
        Humanoid = Character:FindFirstChildOfClass("Humanoid")
        HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")
    end
end

local function InstantTeleport(position)
    if not HumanoidRootPart then return false end
    HumanoidRootPart.CFrame = CFrame.new(position + Vector3.new(0, 3, 0))
    return true
end

local function GetNearestPrompt()
    if not HumanoidRootPart then return nil end
    local rootPos = HumanoidRootPart.Position
    local nearest = nil
    local nearestDist = Config.InteractRange
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") then
            local parent = obj.Parent
            if parent and parent:IsA("BasePart") then
                local dist = (parent.Position - rootPos).Magnitude
                if dist < nearestDist then
                    nearest = obj
                    nearestDist = dist
                end
            end
        end
    end
    return nearest
end

local function HoldInteract()
    local prompt = GetNearestPrompt()
    
    if prompt then
        pcall(function()
            prompt:InputHoldBegin()
            task.wait(Config.HoldTime)
            prompt:InputHoldEnd()
        end)
        return "Prompt"
    else
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            task.wait(Config.HoldTime)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
        end)
        return "Key E"
    end
end

--// MAIN LOOP
local function FarmLoop()
    while State.isFarming do
        if not State.isFarming then break end
        
        -- Point 1: Hold E
        StatusLabel.Text = "üìç POINT 1 - HOLDING"
        StatusLabel.TextColor3 = Color3.fromRGB(180, 100, 255)
        ProgressLabel.Text = "Holding E for 1.0s..."
        
        InstantTeleport(Config.FirstPosition)
        task.wait(0.1)
        
        local method = HoldInteract()
        InfoLabel.Text = string.format("Method: %s", method)
        
        task.wait(0.1)
        
        if not State.isFarming then break end
        
        -- Point 2: Just teleport
        StatusLabel.Text = "üìç POINT 2 - TELEPORT"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
        ProgressLabel.Text = "Teleporting..."
        
        InstantTeleport(Config.SecondPosition)
        task.wait(0.2)
        
        StatusLabel.Text = "‚úÖ LOOP COMPLETE"
        StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
        ProgressLabel.Text = "Restarting..."
        
        task.wait(0.1)
    end
    
    StatusLabel.Text = "‚èπÔ∏è STOPPED"
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    ProgressLabel.Text = "Ready"
    InfoLabel.Text = "Hold: 1.0s | 2 Points"
end

--// Button Events
ToggleBtn.MouseButton1Click:Connect(function()
    State.isFarming = not State.isFarming
    
    if State.isFarming then
        ToggleBtn.Text = "‚èπ STOP"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 100)
        UpdateCharacter()
        task.spawn(FarmLoop)
    else
        ToggleBtn.Text = "‚ñ∂ START"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 255)
    end
end)

MinimizeBtn.MouseButton1Click:Connect(function()
    State.isMinimized = not State.isMinimized
    if State.isMinimized then
        ContentFrame.Visible = false
        MainFrame.Size = UDim2.new(0, 260, 0, 38)
        MinimizeBtn.Text = "+"
    else
        ContentFrame.Visible = true
        MainFrame.Size = UDim2.new(0, 260, 0, 180)
        MinimizeBtn.Text = "‚àí"
    end
end)

CloseBtn.MouseButton1Click:Connect(function()
    State.isFarming = false
    task.wait(0.2)
    for _, conn in pairs(State.connections) do
        if conn then conn:Disconnect() end
    end
    ScreenGui:Destroy()
end)

--// Character Events
table.insert(State.connections, LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid")
    HumanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    if State.isFarming then
        task.wait(1)
        task.spawn(FarmLoop)
    end
end))

--// Notification
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "üéØ Auto Spot",
    Text = "2-Point farm loaded!",
    Duration = 3
})
